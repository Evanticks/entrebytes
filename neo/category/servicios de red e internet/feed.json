{
    "version": "https://jsonfeed.org/version/1",
    "title": "Hexo • All posts by \"servicios de red e internet\" category",
    "description": "",
    "home_page_url": "http://example.com",
    "items": [
        {
            "id": "http://example.com/2023/01/10/dns-vistas/",
            "url": "http://example.com/2023/01/10/dns-vistas/",
            "title": "Configurar un entorno DNS con vistas.",
            "date_published": "2023-01-10T00:38:26.921Z",
            "content_html": "<p><img src=\"/images/vistas-dns-1.png\" alt=\"Descripción de la imagen\"></p>\n<p>Instalaremos un servidor DNS en charlie, de tal forma que todos los nombres de las máquinas deben tener resolución unas con otras al preguntar a charlie.</p>\n<p><img src=\"/images/Untitled-2023-01-10-0143.png\" alt=\"Descripción de la imagen\"></p>\n<p>Las vistas sirven para que cada máquina en un entorno pueda ver las correspondientes salidas a nombres que se hallan dentro del entorno, para esto debemos hacer una configuración en el &#x2F;etc&#x2F;bind&#x2F;named.conf.local, que quedaría de la siguiente manera:</p>\n<pre><code>view interna &#123;\n    match-clients &#123; 192.168.0.0/24; 127.0.0.1; &#125;;\n    allow-recursion &#123; any; &#125;;\n        zone &quot;antonio.gonzalonazareno.org&quot;\n        &#123;\n               type master;\n               file &quot;db.interna.antonio.gonzalonazareno.org&quot;;\n        &#125;;\n        zone &quot;0.168.192.in-addr.arpa&quot;\n        &#123;\n               type master;\n               file &quot;db.0.168.192&quot;;\n        &#125;;\n        zone &quot;16.172.in-addr.arpa&quot;\n        &#123;\n               type master;\n               file &quot;db.16.172&quot;;\n        &#125;;\n        include &quot;/etc/bind/zones.rfc1918&quot;;\n        include &quot;/etc/bind/named.conf.default-zones&quot;;\n&#125;;\n\nview externa &#123;\n    match-clients &#123; 172.22.0.0/16; 192.168.202.2; 172.29.0.0/16;&#125;;\n    allow-recursion &#123; any; &#125;;\n        zone &quot;antonio.gonzalonazareno.org&quot;\n        &#123;\n               type master;\n               file &quot;db.externa.antonio.gonzalonazareno.org&quot;;\n        &#125;;\n        include &quot;/etc/bind/zones.rfc1918&quot;;\n        include &quot;/etc/bind/named.conf.default-zones&quot;;\n&#125;;\n\nview dmz &#123;\n    match-clients &#123;172.22.0.0/16; 172.16.0.0/16; 172.29.0.0/16;&#125;;\n    allow-recursion &#123; any; &#125;;\n        zone &quot;antonio.gonzalonazareno.org&quot;\n        &#123;\n               type master;\n               file &quot;db.dmz.antonio.gonzalonazareno.org&quot;;\n        &#125;;\n        zone &quot;16.172.in-addr.arpa&quot;\n        &#123;\n               type master;\n               file &quot;db.16.172&quot;;\n        &#125;;\n        zone &quot;0.168.192.in-addr.arpa&quot;\n        &#123;\n               type master;\n               file &quot;db.0.168.192&quot;;\n        &#125;;\n        include &quot;/etc/bind/zones.rfc1918&quot;;\n        include &quot;/etc/bind/named.conf.default-zones&quot;;\n&#125;;\n</code></pre>\n<p>Por cada rango de ips, tenemos una vista, ¿por qué tenemos 5 vistas? pues la respuesta sería la siguiente:</p>\n<ul>\n<li>La vista interna que será la vista que tendrán alfa, charlie y delta que contendrá 192.168.0.0</li>\n<li>La vista externa que será la que se muestre al exterior con 172.22.0.0</li>\n<li>La vista dmz que tendrá a bravo con 172.16.0.0</li>\n<li>Tanto la vista dmz como la interna tendrán respuesta sobre resoluciones inversas, pero en la externa no la tenemos, esto es debido a que no debemos proporcionar más información de la esencial a las preguntas desde la vista externa, ya que proviene del exterior y por tanto es menos seguro.</li>\n</ul>\n<p>Una vez creada las zonas debemos crear los ficheros en &#x2F;var&#x2F;cache&#x2F;bind&#x2F;</p>\n<h2 id=\"Zona-externa\"><a href=\"#Zona-externa\" class=\"headerlink\" title=\"Zona externa:\"></a>Zona externa:</h2><pre><code>$TTL    86400\n@       IN      SOA     alfa.antonio.gonzalonazareno.org. root.antonio.gonzalonazareno.org. (\n                              1         ; Serial\n                         604800         ; Refresh\n                          86400         ; Retry\n                        2419200         ; Expire\n                          86400 )       ; Negative Cache TTL\n;\n@       IN      NS              alfa.antonio.gonzalonazareno.org.\n\n$ORIGIN antonio.gonzalonazareno.org.\n\nalfa                    IN      A               172.22.200.193\ndns                     IN      CNAME           alfa\nwww                     IN      CNAME           alfa\n</code></pre>\n<p>Como podemos ver, hay varios cname, esto significa que en las preguntas dns que se realizarán desde el exterior a alfa, la respuesta sería tanto que alfa es el dns como el www, ya que no hay que proporcionar la información del interior.</p>\n<h2 id=\"Zona-interna\"><a href=\"#Zona-interna\" class=\"headerlink\" title=\"Zona interna:\"></a>Zona interna:</h2><pre><code>$TTL    86400\n@       IN      SOA     charlie.antonio.gonzalonazareno.org. root.antonio.gonzalonazareno.org. (\n                              1         ; Serial\n                         604800         ; Refresh\n                          86400         ; Retry\n                        2419200         ; Expire\n                          86400 )       ; Negative Cache TTL\n;\n@       IN      NS              charlie.antonio.gonzalonazareno.org.\n\n$ORIGIN antonio.gonzalonazareno.org.\n\nalfa                    IN      A               192.168.0.1\nbravo                   IN      A               172.16.0.200\ncharlie                 IN      A               192.168.0.2\ndelta                   IN      A               192.168.0.3\nbd                      IN      CNAME           delta\ndns                     IN      CNAME           charlie\nwww                     IN      CNAME           bravo\n</code></pre>\n<p>Ahora en la vista interna podemos ver la información de las ip de las máquinas ya que es un entorno de producción seguro.</p>\n<h2 id=\"Zona-interna-inversa\"><a href=\"#Zona-interna-inversa\" class=\"headerlink\" title=\"Zona interna inversa:\"></a>Zona interna inversa:</h2><pre><code>$TTL    86400\n@       IN      SOA     charlie.antonio.gonzalonazareno.org. root.antonio.gonzalonazareno.org. (\n                              1         ; Serial\n                         604800         ; Refresh\n                          86400         ; Retry\n                        2419200         ; Expire\n                          86400 )       ; Negative Cache TTL\n;\n@       IN      NS              charlie.antonio.gonzalonazareno.org.\n\n$ORIGIN 0.168.192.in-addr.arpa.\n\n1                       IN      PTR             alfa.antonio.gonzalonazareno.org.\n2                       IN      PTR             charlie.antonio.gonzalonazareno.org.\n3                       IN      PTR             delta.antonio.gonzalonazareno.org.\n</code></pre>\n<p>Es importante el ‘.’ después del nombre del fdqn de la máquina ya que si no lo hacemos lo concatenará en la resolución con la ip inversa.</p>\n<h2 id=\"Zona-DMZ\"><a href=\"#Zona-DMZ\" class=\"headerlink\" title=\"Zona DMZ:\"></a>Zona DMZ:</h2><pre><code>$TTL    86400\n@       IN      SOA     charlie.antonio.gonzalonazareno.org. root.antonio.gonzalonazareno.org. (\n                              1         ; Serial\n                         604800         ; Refresh\n                          86400         ; Retry\n                        2419200         ; Expire\n                          86400 )       ; Negative Cache TTL\n;\n@       IN      NS              charlie.antonio.gonzalonazareno.org.\n\n$ORIGIN antonio.gonzalonazareno.org.\n\nalfa                    IN      A               172.16.0.1\nbravo                   IN      A               172.16.0.200\ncharlie                 IN      A               192.168.0.2\ndelta                   IN      A               192.168.0.3\nbd                      IN      CNAME           delta\ndns                     IN      CNAME           charlie\nwww                     IN      CNAME           bravo\n</code></pre>\n<p>La diferencia que podemos apreciar de esta vista es que alfa posee el gateway 172.16.0.1, que es la que verá bravo.</p>\n<h2 id=\"Zona-DMZ-inversa\"><a href=\"#Zona-DMZ-inversa\" class=\"headerlink\" title=\"Zona DMZ inversa:\"></a>Zona DMZ inversa:</h2><pre><code>$TTL    86400\n@       IN      SOA     charlie.antonio.gonzalonazareno.org. root.antonio.gonzalonazareno.org. (\n                              1         ; Serial\n                         604800         ; Refresh\n                          86400         ; Retry\n                        2419200         ; Expire\n                          86400 )       ; Negative Cache TTL\n;\n@       IN      NS              charlie.antonio.gonzalonazareno.org.\n\n$ORIGIN 16.172.in-addr.arpa.\n\n0.200                   IN      PTR             bravo.antonio.gonzalonazareno.org\n</code></pre>\n<p>Una vez hecho esto debemos hacer systemctl restart bind9 y comprobamos que no haya errores de sintaxis, después podemos porbar a realizar consultas con dig.</p>\n<p>Ahora una vez realizadas las configuraciones, podemos jugar un poco con esto! y es que por ejemplo si tenemos una base de datos en delta y el cliente de esta base de datos está en bravo, podemos entrar poniendo el cname que especificamos en el dns.</p>\n<p><img src=\"/images/prueba-dns-mysql.png\" alt=\"Descripción de la imagen\"></p>\n<p>Y si en el caso que en el &#x2F;etc&#x2F;resolv.conf ponemos un search con el nombre del dominio <code>search antonio.gonzalonazareno.org</code> pues no haría falta especificar siquiera el dominio, como en el siguiente ejemplo:</p>\n<p><img src=\"/images/prueba-dns-mysql2.png\" alt=\"Descripción de la imagen\"></p>\n<p>Por último dejamos la web de alfa que realmente estará alojada en bravo:</p>\n<p><img src=\"/images/web-alfa.png\" alt=\"Descripción de la imagen\"></p>\n<h2 id=\"Tips\"><a href=\"#Tips\" class=\"headerlink\" title=\"Tips\"></a>Tips</h2><p>Si queremos servir una web que está en un servidor que no pasa por alfa pero no es alfa, debemos poner una regla de iptables que nos permita dirigir el tráfico por el puerto que especifiquemos a bravo, para poder así acceder desde fuera.</p>\n<p>Si necesitamos acceder a este entorno desde un servidor dns que lo controle, debemos editar el archivo &#x2F;etc&#x2F;bind&#x2F;named.conf.options</p>\n<pre><code> forwarders &#123;\n      192.168.202.2;\n &#125;;\n</code></pre>\n",
            "tags": [
                "Servicios de Red e Internet"
            ]
        },
        {
            "id": "http://example.com/2022/12/13/dns/",
            "url": "http://example.com/2022/12/13/dns/",
            "title": "Configurar un servidor DNS.",
            "date_published": "2022-12-13T21:49:01.673Z",
            "content_html": "<p><img src=\"/images/obelix-4.jpg\" alt=\"Descripción de la imagen\"></p>\n<h2 id=\"Servidor-maestro\"><a href=\"#Servidor-maestro\" class=\"headerlink\" title=\"Servidor maestro\"></a>Servidor maestro</h2><p>Primero comenzaremos actualizando el sistema e instalando el servidor dns bind9, la máquina deberá tener un nombre full qualificated como en mi caso que sería <strong>dns1.antonio.org</strong></p>\n<p><code>apt update &amp;&amp; apt install bind9 -y</code></p>\n<p>Vamos a forzar la salida de las peutciones por ipv4, ya que al no estar configurado de esta forma pueden perderse paquetes al tratar de viajar a través de ipv6, esto lo haremos en &#x2F;etc&#x2F;default&#x2F;named, especificando esta sentencia en  <code>OPTIONS=&quot;-4 -f -u bind&quot;</code>.</p>\n<p>Primero debemos permitir el tráfico desde las diferentes ip en el fichero &#x2F;etc&#x2F;bind&#x2F;named.conf.options.</p>\n<pre><code>allow-query &#123;172.29.0.0/16; 172.22.0.0/16;&#125;;\nallow-transfer &#123; none ;&#125;;\n</code></pre>\n<p>Allow-query se encargará de permitir las consultas a través de los distintos rangos de ip, yo al estar conectado a una vpn debo poner también ese rango para así poder realizar las consultas desde casa.</p>\n<p>Allow-transfer none hará que no se realicen transpasos completos en la información de la zona, esto nos permitirá que no podamos exponer información sensible dentro del servidor dns al realizar las consultas con dig.</p>\n<p>Tras esto, comenzaremos editando el fichero de configuración de zonas, el cual se encargará de administrar las plantillas a las que se les va a realizar una consulta dns con dig.</p>\n<p>&#x2F;etc&#x2F;bind&#x2F;named.conf.local</p>\n<pre><code class=\"shell\">include &quot;/etc/bind/zones.rfc1918&quot;;\nzone &quot;antonio.org&quot; &#123;\n    type master;\n    file &quot;db.antonio.org&quot;;\n    allow-transfer &#123; 172.22.7.171; &#125;;\n    notify yes;\n&#125;;\n\nzone &quot;22.172.in-addr.arpa&quot; &#123;\n    type master;\n    file &quot;db.172.22.0.0&quot;;\n    allow-transfer &#123; 172.22.7.171; &#125;;\n    notify yes;\n&#125;;\n</code></pre>\n<p>Nuestra zona será antonio.org, el cual tendrá el fichero db.antonio.org, hasta ahí será necesario para ralizar solo un dns, para realizar el dns respaldado por un esclavo necesitaremos conceder el traspaso a la ip 172.22.7.171 que será la ip de la máquina esclava, más abajo nos econtraremos con el fichero de zona de resolución inversa, el cual tendrá el nombre del rango de ip que abarcará, y la misma transferencia de zona y el notify que será lo que avise al esclavo que ha habido un cambio en el maestro.</p>\n<p>Si nos vamos al fichero &#x2F;var&#x2F;cache&#x2F;bind&#x2F;db.antonio.org podemos ver los siguientes componentes:</p>\n<pre><code class=\"shell\">$TTL    86400\n@       IN      SOA     dns1.antonio.org. root.antonio.org. (\n                              6         ; Serial\n                         604800         ; Refresh\n                          86400         ; Retry\n                        2419200         ; Expire\n                          86400 )       ; Negative Cache TTL\n;\n\n@       IN      NS              dns1.antonio.org.\n@       IN      NS              dns2.antonio.org.\n@       IN      MX      10      correo.antonio.org.\n\n\n$ORIGIN antonio.org.\n\ndns1                    IN      A       172.22.7.155\ndns2                    IN      A       172.22.7.171\ncorreo                  IN      A       172.22.200.101\nasterix                 IN      A       172.22.200.102\nobelix                  IN      A       172.22.200.103\nprueba                  IN      A       172.22.200.120\nwww                     IN      CNAME   asterix\n;informatica             IN      CNAME   asterix\nftp                     IN      CNAME   obelix\nentrebytes              IN      A       172.22.200.166\n\n$ORIGIN informatica.antonio.org.\n@       IN      NS    dns\ndns     IN      A     172.22.7.177\n</code></pre>\n<p>Pues bien, deberemos cumplimentar de la siguiente forma el fichero, el cual tiene las siguientes definiciones:<br>La primera parte es el SOA, que es fdqn de la máquina maestra, acompañado del correo del administrador, el cual será con puntos.</p>\n<p>En la segunda parte podemos ver los nameservers, el cual tendrá el @, esto mostrará las máquinas a disposición del fdqn que hemos elegido, en nuestro caso tendremos el de la máquina maestra, la del esclavo y la del correo.</p>\n<p>Origin es la variable que va a tener antonio.org. para no tener que repetir continuamente el nombre del dominio en los registros.</p>\n<p>Los registros de tipo A tendrán una ip asociada, estos se encargan de darle nombre a la ip de dentro del dominio, como dns1 que tiene una 172.22.7.155 o la del esclavo, que tendrá la 172.22.7.171</p>\n<p>Los registros de tipo CNAME son nombres relacionados a otros nombres, como por ejemplo ftp, que va relacionado al nombre obelix y que tendrá la ip 172.22.200.103. entonces al realizar la consulta en el apartado ANSWER nos daría el nombre completo al que está asociado.</p>\n<p><img src=\"/images/obelix.png\" alt=\"Descripción de la imagen\"></p>\n<p>Ahora vamos con el fichero de zona de resolución inversa, el cual crearemos en &#x2F;var&#x2F;cache&#x2F;bind&#x2F;db.172.22.0.0</p>\n<pre><code class=\"shell\">$TTL    86400\n@       IN      SOA     dns1.antonio.org. root.antonio.org. (\n                              1         ; Serial\n                         604800         ; Refresh\n                          86400         ; Retry\n                        2419200         ; Expire\n                          86400 )       ; Negative Cache TTL\n;\n@      IN      NS              dns1.antonio.org.\n@      IN      NS              dns2.antonio.org.\n\n$ORIGIN 22.172.in-addr.arpa.\n\n155.7                  IN      PTR             dns1.antonio.org.\n171.7                  IN      PTR             dns2.antonio.org.\n101.200                IN      PTR             correo.antonio.org.\n102.200                IN      PTR             asterix.antonio.org.\n200.103                IN      PTR             obelix.antonio.org.\n200.166                IN      PTR             entrebytes.antonio.org.\n</code></pre>\n<p>El fichero es muy similar al de la resolución directa, pero en este caso especificaremos la IP de la manera opuesta, con PTR conseguiremos obtener el nombre gracias a una petición inversa a la ip que hemos configurado, también pondremos la del servidor esclavo.</p>\n<p><img src=\"/images/obelix-2.png\" alt=\"Descripción de la imagen\"></p>\n<p>Por último, debemos editar el fichero &#x2F;etc&#x2F;bind&#x2F;zones.rfc1918 que se encarga de proporcionar la plantilla empty para las resoluciones no configuradas, de manera que debamos comentar el rango de ips de <code>//zone &quot;22.172.in-addr.arpa&quot;  &#123; type master; file &quot;/etc/bind/db.empty&quot;; &#125;;</code> ya que nosotros hemos configurado anteriormente.</p>\n<p>ahora solo nos queda realizar un <code>systemctl restart bind9</code> y <code>systemctl status bind9</code> para comprobar de que el servicio está activo y sin errores.</p>\n<h2 id=\"Servidor-esclavo\"><a href=\"#Servidor-esclavo\" class=\"headerlink\" title=\"Servidor esclavo\"></a>Servidor esclavo</h2><p>Primero comenzaremos actualizando el sistema e instalando el servidor dns bind9, la máquina deberá tener un nombre full qualificated como en mi caso que sería <strong>dns2.antonio.org</strong></p>\n<p><code>apt update &amp;&amp; apt install bind9 -y</code></p>\n<p>Vamos a forzar la salida de las peutciones por ipv4, ya que al no estar configurado de esta forma pueden perderse paquetes al tratar de viajar a través de ipv6, esto lo haremos en &#x2F;etc&#x2F;default&#x2F;named, especificando esta sentencia en  <code>OPTIONS=&quot;-4 -f -u bind&quot;</code>.</p>\n<p>&#x2F;etc&#x2F;bind&#x2F;named.conf.local</p>\n<pre><code class=\"shell\">include &quot;/etc/bind/zones.rfc1918&quot;;\nzone &quot;antonio.org&quot; &#123;\n    type slave;\n    file &quot;db.antonio.org&quot;;\n    masters &#123; 172.22.7.155; &#125;;\n&#125;;\nzone &quot;22.172.in-addr.arpa&quot; &#123;\n    type slave;\n    file &quot;db.172.22.0.0&quot;;\n    masters &#123; 172.22.7.155; &#125;;\n&#125;;\n</code></pre>\n<p>Hacemos un <code>systemctl restart bind9</code> y <code>systemctl status bind9</code> para comprobar de que el servicio está activo y sin errores.</p>\n<p>Tras esto, cuando modifiquemos el servidor maestro subimos el serial de tal forma que sea mayor al de la máquina esclava, y de esta manera realizará la transferencia.</p>\n<p><img src=\"/images/obelix-3.png\" alt=\"Descripción de la imagen\"></p>\n<h2 id=\"Delegacion-de-subdominio\"><a href=\"#Delegacion-de-subdominio\" class=\"headerlink\" title=\"Delegación de subdominio\"></a>Delegación de subdominio</h2><p>Pra delegar un subdominio primero comenzaremos actualizando el sistema e instalando el servidor dns bind9, la máquina deberá tener un nombre full qualificated como en mi caso que sería <strong>dns.informatica.antonio.org</strong></p>\n<p><code>apt update &amp;&amp; apt install bind9 -y</code></p>\n<p>Vamos a forzar la salida de las peutciones por ipv4, ya que al no estar configurado de esta forma pueden perderse paquetes al tratar de viajar a través de ipv6, esto lo haremos en &#x2F;etc&#x2F;default&#x2F;named, especificando esta sentencia en  <code>OPTIONS=&quot;-4 -f -u bind&quot;</code>.</p>\n<p>Una vez hecho esto, como podemos ver en la máquina maestra, tenemos un apartado en db.antonio.org en el cual especificamos los siguientes parámetros:</p>\n<pre><code class=\"shell\">$ORIGIN informatica.antonio.org.\n@       IN      NS    dns\ndns     IN      A     172.22.7.177\n</code></pre>\n<p>Con esto estaremos delegando el subdominio para que lo gestione dns.informatica.antonio.org, si nos vamos a esta máquina, debemos configurar el dominio de la siguiente forma:</p>\n<p>&#x2F;etc&#x2F;bind&#x2F;named.conf.local</p>\n<pre><code>zone &quot;informatica.antonio.org&quot; &#123;\n    type master;\n    file &quot;db.informatica.antonio.org&quot;;\n&#125;;\n</code></pre>\n<p>Luego nos vamos a &#x2F;var&#x2F;cache&#x2F;bind&#x2F;db.informatica.antonio.org</p>\n<pre><code class=\"shell\">$TTL    86400\n@       IN      SOA     dns.informatica.antonio.org. root.informatica.antonio.org. (\n                              1         ; Serial\n                         604800         ; Refresh\n                          86400         ; Retry\n                        2419200         ; Expire\n                          86400 )       ; Negative Cache TTL\n;\n@       IN      NS              dns.informatica.antonio.org.\n@       IN      MX      10      mail.informatica.antonio.org.\n\n$ORIGIN informatica.antonio.org.\n\ndns                     IN      A               172.22.7.177\nmail                    IN      A               172.22.7.177\nweb                     IN      A               172.22.7.177\nwww                     IN      CNAME           web\nentrebytes              IN      CNAME           web\n</code></pre>\n<h2 id=\"Tips\"><a href=\"#Tips\" class=\"headerlink\" title=\"Tips\"></a>Tips</h2><p>Si realizamos cambios a veces no se verán reflejados ya que el servicio DNS la almacena en caché, para borrarla necesitaremos ejecutar <code>rndc flush</code> en la máquina maestra.</p>\n<p>Para poder realizar las consultas sin especificar la ip a través de @, necesitaremos agregar un nameserver XXX.XXX.XXX.XXX en &#x2F;etc&#x2F;resolv.conf</p>\n<p>En el caso de dns.informatica.antonio.org no es necesario descomentar el include “&#x2F;etc&#x2F;bind&#x2F;zones.rfc1918”; ya que se ocupará de gestionarlo la máquina maestra.</p>\n<p>Para detectar con información más detallada los errores de plantillas db, necesitaremos ejecutar <code>named-checkzone antonio.org /var/cache/bind/db.antonio.org</code></p>\n<p>Si queremos detectar los errores del fichero de zonas, necesitaremos ejecutar <code>named-checkconf</code></p>\n",
            "tags": [
                "Servicios de Red e Internet"
            ]
        },
        {
            "id": "http://example.com/2022/10/13/Ansible+Vagrant/",
            "url": "http://example.com/2022/10/13/Ansible+Vagrant/",
            "title": "Ansible + Vagrant, configurar y enrutar servidor web.",
            "date_published": "2022-10-13T17:45:40.684Z",
            "content_html": "<p><img src=\"/images/ansibleandvagrant.jpg\" alt=\"Descripción de la imagen\"></p>\n<p>Comenzaremos este post viendo como adjuntamos una box <a href=\"https://app.vagrantup.com/boxes/search\">https://app.vagrantup.com/boxes/search</a><br>buscamos por ejemplo la de debian&#x2F;ullseye, vamos a nuestra terminal y escribimos lo siguiente:<br><code>vagrant box add debian/bullseye64</code></p>\n<p>En ese momento se guardará en <code>~/.vagrant.d/boxes</code><br>Bueno, dicho esto procedemos a crear la carpeta donde vamos a trabajar y hacemos un <code>vagrant init</code>, esto hará que se cree un archivo llamado vagrantfile, el cual debe quedar de la siguiente manera:</p>\n<pre><code>Vagrant.configure(&quot;2&quot;) do |config|\n    config.vm.define :nodo1 do |nodo1|\n      nodo1.vm.box = &quot;debian/bullseye64&quot;\n      nodo1.vm.hostname= &quot;nodo1&quot;\n      nodo1.vm.synced_folder &quot;.&quot;, &quot;/vagrant&quot;, disabled: true\n      nodo1.vm.network :public_network,\n        :dev =&gt; &quot;br0&quot;,\n        :mode =&gt; &quot;bridge&quot;,\n        :type =&gt; &quot;bridge&quot;,\n        use_dhcp_assigned_default_route: true\n      nodo1.vm.network :private_network,\n        :libvirt__network_name =&gt; &quot;red1&quot;,\n        :libvirt__dhcp_enabled =&gt; false,\n        :ip =&gt; &quot;10.0.0.10&quot;,\n        :libvirt__forward_mode =&gt; &quot;veryisolated&quot;\n    end\n    config.vm.define :nodo2 do |nodo2|\n      nodo2.vm.box = &quot;debian/bullseye64&quot;\n      nodo2.vm.hostname = &quot;nodo2&quot;\n      nodo2.vm.synced_folder &quot;.&quot;, &quot;/vagrant&quot;, disabled: true\n      nodo2.vm.network :private_network,\n        :libvirt__network_name =&gt; &quot;red1&quot;,\n        :libvirt__dhcp_enabled =&gt; false,\n        :ip =&gt; &quot;10.0.0.11&quot;,\n        :libvirt__forward_mode =&gt; &quot;veryisolated&quot;,\n        use_dhcp_assigned_default_route: true\n    end\nend\n</code></pre>\n<p>Vamos a explicar paso por paso qué vemos en el código:</p>\n<ul>\n<li>El vagrantfile debe estar perfectamente alineado, los end con sus respectivos config.</li>\n<li>Al ser dos máquinas las vamos a llamar nodo1 y nodo2, que una será el router y la segunda el servidor que aloje apache</li>\n<li>Si nos fijamos con atención podemos ver que <strong>nodo1</strong> tiene dos redes, una será pública, la cual tiene un bridge por donde saldrá a internet, y una red privada muy aislada, la cual no contendrá nada más que una ip estática, pondremos que la ruta por defecto va a ser el bridge que nos llevará a internet.</li>\n<li>En <strong>nodo2</strong> tendremos una red privada, más tarde procederemos a ejecutar unas reglas que nos permitan salir por el exterior a través de la red muy aislada con <strong>nat</strong></li>\n</ul>\n<p>Una vez hecho esto procedemos a ver de cerca lo que contiene Ansible, el cual ejecutaremos tras iniciar las máquinas de Vagrant junto con sus redes.</p>\n<p><img src=\"/images/Ansible.png\" alt=\"Descripción de la imagen\"></p>\n<p>Como podemos ver, hay una serie de carpetas llamadas roles, cada rol va a ejecutar una o varias tareas dependiendo de lo que se trate, por lo tanto así quedaría por ejemplo el activado del bit de forwarding del router:</p>\n<pre><code>- ansible.posix.sysctl:\n    name: net.ipv4.ip_forward\n    value: &#39;1&#39;\n    sysctl_set: yes\n</code></pre>\n<p>Estas tareas tienen un orden, y se realiza dentro de site.yml:</p>\n<pre><code>- hosts: nodo1\n  become: true\n  roles:\n   - role: copy\n\n- hosts: all\n  become: true\n  roles:\n   - role: commons\n\n- hosts: nodo2\n  become: true\n  roles:\n   - role: copy2\n   - role: apache2\n\n- hosts: nodo1\n  become: true\n  roles:\n   - role: ipv4\n</code></pre>\n<p>Con un poco de conocimientos en sistemas podemos ver claramente qué realiza cada rol.</p>\n<p>Ahora vamos a poner la lupa en <code>roles/commons/handlers/main.yaml</code>, una parte muy importante de la ejecución de Ansible:</p>\n<pre><code>- name: reiniciando maquina\n  ansible.builtin.reboot:\n    msg: &quot;reboot by Ansible&quot;\n    pre_reboot_delay: 5\n    post_reboot_delay: 10\n    test_command: &quot;whoami&quot;\n</code></pre>\n<p>Este handler se ejecuta en el momento en el que se hace un llamamiento, en nuestro caso es cuando copiamos al router un fichero configurado para etc&#x2F;network&#x2F;interfaces, con sus interfaces, ruta por defecto e iptables:</p>\n<p><img src=\"/images/interfaces.png\" alt=\"Descripción de la imagen\"></p>\n<p>podemos ver como en <code>roles/copy/tasks/main.yaml</code> hace el llamamiento al <strong>handler</strong> en el notify:</p>\n<pre><code>- name: Copiando al etc/network/interfaces\n  ansible.builtin.copy:\n    src: interfaz_nodo1/interfaces\n    dest: /etc/network/\n    owner: root\n    group: root\n    mode: u-rw,g-wx,o-rwx\n  notify:\n    - reiniciando maquina\n</code></pre>\n<p>A continuación podemos copiar nuestra clave pública a través de la tarea <strong>commons</strong> que será lo que nos permita atravesar por ssh sin utilizar la clave vagrant, es decir, la nuestra.</p>\n<pre><code>- name: Ensure system is updated\n  apt: update_cache=yes upgrade=yes\n\n- name: Set authorized key took from file\n  authorized_key:\n    user: vagrant\n    state: present\n    key: &quot;&#123;&#123; lookup('file', '/home/antonio/.ssh/id_rsa.pub') &#125;&#125;&quot;\n</code></pre>\n<p>Luego pasamos a la instalación de Apache,a través del módulo apt para instalar apache2, ports.conf es la configuración de los puertos por los que escucha, también alberga el fichero index.html y una plantilla jinja2.</p>\n<p>Por último pero no menos importante está el fichero hosts, el cual será el inventario por el cual el sistema sabrá cuál será nodo1 y cuál nodo2, a través de las correspondientes ips que asignaremos,el usuario más la clave privada que asignará vagrant:</p>\n<pre><code>all:\n  children:\n    servidores_web:\n      hosts:\n        nodo1:\n          ansible_ssh_host: 192.168.121.212\n          ansible_ssh_user: vagrant\n          ansible_ssh_private_key_file: ../.vagrant/machines/nodo1/libvirt/private_key\n        nodo2:\n          ansible_ssh_host: 192.168.121.111\n          ansible_ssh_user: vagrant\n          ansible_ssh_private_key_file: ../.vagrant/machines/nodo2/libvirt/private_key\n</code></pre>\n<p>con esto solo necesitaremos ejecutar el <code>ansible-playbook site.yaml</code> y tendremos enrutado y configurado nuestro servidor web.</p>\n",
            "tags": [
                "Servicios de Red e Internet"
            ]
        }
    ]
}